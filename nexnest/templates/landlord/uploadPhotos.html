{% extends "base.html" %} 
{% block content %}
    <form id="photoForm" action="{{url_for('listings.uploadPhotos', listingID=listingID)}}" role="form" data-toggle="validator" method='POST' enctype="multipart/form-data">
        {{form.csrf_token}}
        <div class="row nexnest-font" style="color: #656264">
            <div class="col-md-1"></div>
            <div class="col-xs-12 col-md-10">
                <div class="row" style="padding-top: 45px;">
                    <div class="col-xs-12" style="padding-left: 0px;">
                        <h1 style="font-size: 43px;">Upload Photos</h1>
                    </div>
                </div>
                <div class="row">
                    <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12 col-xl-12">
                        <br>
                        <div class="row" style="width: 100%;">
                            <div class="form-group" style="width: 100%;">
                                <h3><strong>Cover Photo (This photo will appear first on your listing)</strong><small class="text-muted" style="padding-left: 10px;">Not Required</small></h3>
                                {{form.bannerPicture(class='form-control file')}}
                            </div>
                        </div>
                        
                        <div class="row" style="width: 100%;">
                            <div class="form-group" style="width: 100%;">
                                <h3><strong>Other Photos of Property (Up to 15)</strong><small class="text-muted" style="padding-left: 10px;">Not Required</small></h3>
                                {{form.pictures(class='form-control file-loading', multiple='')}}
                            </div>
                        </div>
                        {{form.nextAction}}                        
                    </div>
                </div>
                <div class="row" style="padding-bottom: 60px;">
                    <div class="col-xs-12" style="text-align: right;">
                        <a id="createListingButton" href='#' class="btn btn-light-green" data-toggle="modal" data-target="#confirmModal" style="margin-right: 15px;"><i class="fa fa-plus" aria-hidden="true" style="padding-right: 5px;"></i> Post Listing</a>
                        <button id="createListingButton_Loading" disabled class="btn btn-light-green" data-toggle="modal" data-target="#confirmModal" style="margin-right: 15px; display: none; width: 148px;"><i class="fa fa-spinner fa-spin" aria-hidden="true" style="padding-right: 5px;"></i></button>
                    </div>
                </div>
            </div>
        </div>
    </form>
<!--Confirm Listing-->
    <div class="modal fade" id="confirmModal" tabindex="-1" role="dialog" aria-labelledby="confirm" aria-hidden="true">
        <div class="modal-dialog" role="document" style="max-width: 700px;">
            <div class="modal-content nexnest-font" style="font-size: 20px; color: #656264;">
                <div class="modal-header" style="background-color: #f4c359;">                  
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                    <h1 style="color: white;"><i class="icon icon-crown" aria-hidden="true" style="padding-right: 5px;"></i> Upgrade My Listing</h1>
                </div>
                <div class="modal-body nexnest-font" style="font-size: 20px; color: #656264;">
                    <div class="row">
                        <div class="col-xs-1"></div>
                        <div class="col-xs-10">                            
                            You have succesfully created your listing!
                            <br><br>
                            <div class="row">
                                <div class="col-xs-12" style="padding-left: 30px;">
                                    Your listing will now be made live for anyone to find and request to live there!
                                </div>
                            </div>
                        </div>
                    </div>
                    <div id="groupNumber" style="display: none;"></div>
                </div>
                <div class="modal-footer" style="text-align: left;">
                    <div class="row">                        
                        <div class="col-xs-12 col-sm-12" style="padding-top: 10px; text-align: right;">
                            <button style="padding-right: 10px; color: #656264;" onClick="submitListingForm('makeLive')"> No Thanks</button>
                            <button type="button" style="width: 225px;" class="btn btn-yellow pull-right" onClick="submitListingForm('upgrade')" data-dismiss="modal"><i class="icon icon-crown" aria-hidden="true" style="padding-right: 5px;"></i> Upgrade Listing</button>
                        </div>
                    </div>  
                </div>
            </div>
        </div>
    </div>
{% endblock %}
{% block scripts %}
<script>
    var csrf_token = "{{ csrf_token() }}";

    $.ajaxSetup({
        beforeSend: function(xhr, settings) {
            if (!/^(GET|HEAD|OPTIONS|TRACE)$/i.test(settings.type) && !this.crossDomain) {
                xhr.setRequestHeader("X-CSRFToken", csrf_token);
            }
        }
    });

    function submitListingForm(nextAction) {
        $('#createListingButton').hide();
        $('#createListingButton_Loading').show();
        $('#pictures').fileinput('upload');
        $("#nextAction").val(nextAction);
        $("form#photoForm").submit();
    }

    $("#bannerPicture").fileinput({
        theme: "fa",
        showUpload: false,
        showCancel: false,
        initialPreview: [
            {% if bannerPath %}
                "{{bannerPath}}",
            {% endif %}
        ],
        initialPreviewAsData: true, // identify if you are sending preview data only and not the raw markup
        initialPreviewFileType: 'image', // image is the default and can be overridden in config below
        initialPreviewConfig: [
            {% if bannerPath %}
                {caption: "Banner Photo", size: 827000, width: "120px", url: "/listing/delete/{{bannerPath}}", key: 1},
            {% endif %}
        ]
    });

    csrfToken = "{{csrf_token()}}"

    $("#pictures").fileinput({
        uploadUrl: "/listing/upload/{{listingID}}", // server upload action
        uploadAsync: true,
        theme: "fa",
        maxFileCount: 15,
        showCancel: false,
        showPreview: true,
        overwriteInitial: false,
        showUpload: false,
        initialPreview: [
            {% if picturePaths %}
                {% for picture in picturePaths %}
                    "/uploads/listings/{{listingID}}/pictures/{{picture}}",
                {% endfor %}
            {% endif %}
        ],
        initialPreviewAsData: true, // identify if you are sending preview data only and not the raw markup
        initialPreviewFileType: 'image', // image is the default and can be overridden in config below
        initialPreviewConfig: [
            {% if picturePaths %}
                {% for picture in picturePaths %}
                    {caption: "Picture", size: 827000, width: "120px", url: "/listing/delete/{{listingID}}/{{picture}}", key: 1,extra: {csrf_token:csrfToken}},
                {% endfor %}
            {% endif %}
        ]
    }).on('filesorted', function(e, params) {
    console.log('File sorted params', params);
    });

    // window.onbeforeunload = function() { return "Do not go back and edit the listing details you just made. Trying to do so can cause major issues. You can edit the listing after you upload photos"; };

</script>
{% endblock %}
