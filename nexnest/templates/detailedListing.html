{% extends "base.html" %}
{% block content %}
	<div class="row">
		<div class="col-xs-0 col-md-2 col-lg-2"></div>
		<div class="col-xs-12 col-md-8 col-lg-8" style="padding-left: 40px;">
			<div class="row">
				{% if listing.banner_photo_url %}
					<a class="hidden-xs-down test-popup-link" href="{{pictures[0]}}" style="width: 100%;">
						<img src="{{bannerPhoto}}" style="height: 40vh; width: 90%; margin-left: 5%;">
					</a>
					<a class="hidden-sm-up test-popup-link" href="{{pictures[0]}}">
						<img src="{{bannerPhoto}}" style="height: 30vh; width: 100%;">
					</a>
				 {% else %}
					<a class="test-popup-link" href="/static/img/defaultHouse.png" style="width: 100%;">
						<img src="/static/img/defaultHouse.png" style="height: 350px; width: 100%;">
					</a>
				 {% endif %}
			</div>
			<br>
			{% if pictures|length > 0 %}
				<div class="row">
					<div class="col-xs-12">
						<div class="wrap">
							<div>
								<div class="frame" id="basic">								
								  	<ul class="clearfix">
								      	{% for picture in pictures %}
								      		<li>
												<a href="{{picture}}" data-group="1" class="galleryItem">
													<img src="{{picture}}" style="width: 100%;">
												</a>
											</li>
										{% endfor %}
								    </ul>
								</div>
								<i class="prevPage fa fa-5x fa-angle-left" aria-hidden="true" style="position: absolute; top: 15%; left: -2.5%"></i>
								<i class="nextPage fa fa-5x fa-angle-right" aria-hidden="true" style="position: absolute; top: 15%; left: 100%"></i>
							</div>
						</div>
					</div>
				</div>
			{% else %}
				
			{% endif %}
		</div>
	</div>
	<div class="row">
		<div class="col-xs-1 col-md-2 col-lg-2"></div>
		<div class="col-xs-10 col-md-8 col-lg-8">
			<div class="row">
				<div class="col-xs-8">
					<br>					
					<h4>{{ listing.street }},
					<br>
					{{ listing.city }}, {{ listing.state }}, {{ listing.zip_code }}</h4>
					<h5>${{ listing.price }} Per Bedroom Per {{ listing.rent_due }}</h5>
				</div>
				{% if listing.floor_plan_url %}
					<div class="col-xs-4" style="text-align: right;">
						<br>
						<a class="btn btn-primary" href="{{listing.floor_plan_url}}">Floor Plan</a>
						{% if current_user.is_authenticated %}
						{% if not current_user in listing.landLordsAsUsers() %}
							<a href="#" class="btn btn-danger" data-toggle="modal" data-target="#listingReportModal"><i class="fa fa-x fa-exclamation-triangle" title="Report This Listing" aria-hidden="true" style="color: white; padding-left: 15px; position: relative; top: 9px;"></i> Report Listing</a>
						{% endif %}
					{% endif %}
					</div>
				{% else %}
					{% if current_user.is_authenticated %}
						{% if not current_user in listing.landLordsAsUsers() %}
							<div class="col-xs-4" style="text-align: right;">
								<a href="#" class="btn btn-danger" data-toggle="modal" data-target="#listingReportModal"><i class="fa fa fa-exclamation-triangle" title="Report This Listing" aria-hidden="true" style="color: white;"></i> Report Listing</a>
							</div>
						{% endif %}
					{% endif %}
				{% endif %}
			</div>
			{% if current_user.is_authenticated %}
				{% if not current_user in listing.landLordsAsUsers() %}
				<hr>
				<div class="row">
                    <div class="col-xs-12" id="favorited{{listing.id}}">

                    </div>
                </div>
				<div class="row hidden-md-down">
					<div class="col-xs-12 col-lg-3" style="text-align:left">
						<a href="{{ url_for('indexs.index') }}" class="btn btn-primary">Contact Landlord</a>
					</div>
					<div class="col-xs-12 col-lg-3 col-centered">					
			            <a href='#' class="btn btn-primary" data-toggle="modal" data-target="#selectGroupForTourModal">Request Tour</a>
					</div>
					<div class="col-xs-12 col-lg-3 col-centered">
						<a href='#' class="btn btn-primary" data-toggle="modal" data-target="#selectGroupForHouseModal">Request House</a>
					</div>
					<div class="col-xs-12 col-lg-3" style="text-align:right">
						<a href='#' class="btn btn-primary" data-toggle="modal" data-target="#suggestListingModal">Favorite For Group</a>
					</div>
				</div>
				<div class="row hidden-lg-up">
					<div class="col-xs-12 col-md-6 col-lg-3 col-centered">
						<a href="{{ url_for('indexs.index') }}" class="btn btn-primary" style="width: 160.31px;">Contact Landlord</a>
					</div>
					<br><br>
					<div class="col-xs-12 col-md-6 col-lg-3 col-centered">					
			            <a href='#' class="btn btn-primary" data-toggle="modal" data-target="#selectGroupForTourModal" style="width: 160.31px;">Request Tour</a>
					</div>
					<br><br>
					<div class="col-xs-12 col-md-6 col-lg-3 col-centered">
						<a href='#' class="btn btn-primary" data-toggle="modal" data-target="#selectGroupForHouseModal" style="width: 160.31px;">Request House</a>
					</div>
					<br><br>
					<div class="col-xs-12 col-md-6 col-lg-3 col-centered">
						<a href='#' class="btn btn-primary" data-toggle="modal" data-target="#suggestListingModal" style="width: 160.31px;">Favorite For Group</a>
					</div>
				</div>
				{% endif %}
				{% if current_user in listing.landLordsAsUsers() %}
					<a href="{{url_for('listings.cloneListing', listingID=listing.id)}}" class="btn btn-primary">Clone Listing</a>
					{% if listing.isEditableBy(current_user) %}
						<a href="{{url_for('listings.editListing', listingID=listing.id)}}" class="btn btn-primary">Edit Listing</a>
					{% endif %}
				{% endif %}
			{% endif %}
			
			<hr>
			<div class="row">
				<div class="col-xl-12">
					<strong style="padding-right: 5px;">Property Description: </strong> {{ listing.description }}
				</div>
			</div>
			<hr>
			<div class="row">
				<div class="col-sm-4">
					<h2>Lease:</h2>
				</div>
				<div class="col-sm-8">
					<div class="row">
						<div class="col-xs-12 col-md-6 col-xl-4">
							<strong>Time Period:</strong> {{ listing.time_period }}
						</div>
						<div class="col-xs-12 col-md-6 col-xl-4">
							<strong>Start Date:</strong> {{ listing.start_date }}
						</div>
						<div class="col-xs-12 col-md-6 col-xl-4">
							<strong>End Date:</strong> {{ listing.end_date }}
						</div>
						{% if listing.rent_due == "semester" %}	
							<div class="col-xs-12 col-md-6 col-xl-4">				
								<strong>First Semester Rent Due:</strong> {{ listing.first_semester_rent_due_date }}
							</div>
							<div class="col-xs-12 col-md-6 col-xl-4">
								<strong>Second Semester Rent Due:</strong> {{ listing.second_semester_rent_due_date }}
							</div>
						{% elif listing.rent_due == "monthly" %}
							<div class="col-xs-12 col-md-6 col-xl-4">
								<strong>Rent Due: </strong>1st of each month
							</div>
						{% endif %}
					</div>
				</div>
			</div>
			<hr style="padding-bottom: 15px;">
			<div class="row">
				<div class="col-sm-4">
					<h2>Property:</h2>
				</div>
				<div class="col-sm-8">
					<div class="row">
						<div class="col-xs-12 col-md-6 col-xl-4">
							<strong>Property Type:</strong> {{ listing.property_type }}
						</div>
						<div class="col-xs-12 col-md-6 col-xl-4">
							<i class="fa fa-bed" aria-hidden="true"></i> {{ listing.num_bedrooms }} Beds
						</div>
						<div class="col-xs-12 col-md-6 col-xl-4">
							<i class="fa fa-bath" aria-hidden="true"></i>{{ listing.num_full_baths }} Full Baths
						</div>
						{% if listing.num_half_baths > 0 %}
							<div class="col-xs-12 col-md-6 col-xl-4">
								<i class="fa fa-bath" aria-hidden="true"></i>{{ listing.num_half_baths }} Half Baths
							</div>
						{% endif %}
						{% if listing.square_footage %}
							<div class="col-xs-12 col-md-6 col-xl-4">
								{{ listing.square_footage }} SQFT
							</div>
						{% endif %}
						{% if listing.furnished %}
							<div class="col-xs-12 col-md-6 col-xl-4">
								Property Furnished
							</div>							
						{% endif %}
						{% if listing.handicap %}
							<div class="col-xs-12 col-md-6 col-xl-4">
								Handicap Accessible
							</div>							
						{% endif %}
						<div class="col-xs-12 col-md-6 col-xl-4">
							Parking: {{ listing.parking }}
						</div>
					</div>
				</div>
			</div>
			<hr style="padding-bottom: 15px;">
			<div class="row">
				<div class="col-sm-4">
					<h2>Distance to {{ listing.schools[0].school.name }}:</h2>
				</div>
				<div class="col-sm-8">
					<div class="row">
						<div class="col-xs-12 col-md-6 col-xl-4">
							<strong>Distance:</strong>
						</div>
						<div class="col-xs-12 col-md-6 col-xl-4">
							<strong>Driving Time:</strong>
						</div>
						<div class="col-xs-12 col-md-6 col-xl-4">
							<strong>Walking Time:</strong>
						</div>
					</div>
					<div class="row">
						<div class="col-xs-12 col-md-6 col-xl-4">
							{{ listing.schools[0].driving_miles }} Miles
						</div>
						<div class="col-xs-12 col-md-6 col-xl-4">
							<i class="fa fa-car" aria-hidden="true"></i>{{ listing.schools[0].driving_time }} Minutes
						</div>
						<div class="col-xs-12 col-md-6 col-xl-4">
							<i class="fa fa-male" aria-hidden="true"></i>{{ listing.schools[0].walking_time }} Minutes
						</div>
					</div>
				</div>
			</div>
			<hr style="padding-bottom: 15px;">
			{% if listing.hasAppliances %}
				<div class="row">
					<div class="col-sm-4">
						<h2>Appliances:</h2>
					</div>
					<div class="col-sm-8">
						<div class="row">						
							{% if listing.air_conditioning %}
								<div class="col-xs-12 col-md-6 col-xl-4">
									<li>Air Conditioning</li>
								</div>
							{% endif %}
							{% if listing.dishwasher %}
								<div class="col-xs-12 col-md-6 col-xl-4">
									<li>Dishwasher</li>
								</div>							
							{% endif %}	
							{% if listing.washer %}
								<div class="col-xs-12 col-md-6 col-xl-4">
									<li>Washing Machine</li>
								</div>
							{% endif %}
							{% if listing.dryer %}
								<div class="col-xs-12 col-md-6 col-xl-4">
									<li>Dryer</li>
								</div>							
							{% endif %}
							{% if listing.washer or listing.dryer %}
								{% if listing.washer_free %}
									<div class="col-xs-12 col-md-6 col-xl-4">
										<i class="fa fa-usd" aria-hidden="true"></i><li>Laundry is Free to use</li>
									</div>							
								{% endif %}
							{% endif %}
						</div>
					</div>
				</div>
				<hr style="padding-bottom: 15px;">
			{% endif %}
			{% if listing.hasUtilities %}
				<div class="row">
					<div class="col-sm-4">
						<h2>Utilities Included in Rent:</h2>
					</div>
					<div class="col-sm-8">
						<div class="row">						
							{% if listing.electricity %}
								<div class="col-xs-12 col-md-6 col-xl-4">
									<li>Electricity</li>
								</div>
							{% endif %}
							{% if listing.heat_gas %}
								<div class="col-xs-12 col-md-6 col-xl-4">
									<li>Heat/Gas</li>
								</div>
							{% endif %}
							{% if listing.water %}
								<div class="col-xs-12 col-md-6 col-xl-4">
									<li>Water</li>
								</div>							
							{% endif %}
							{% if listing.internet %}
								<div class="col-xs-12 col-md-6 col-xl-4">
									<li>Internet</li>
								</div>							
							{% endif %}
							{% if listing.cable %}
								<div class="col-xs-12 col-md-6 col-xl-4">
									<li>Cable</li>
								</div>							
							{% endif %}					
						</div>
					</div>
				</div>
				<hr style="padding-bottom: 15px;">
			{% endif %}
			{% if listing.hasServices %}
				<div class="row">
					<div class="col-sm-4">
						<h2>Services Included:</h2>
					</div>
					<div class="col-sm-8">
						<div class="row">						
							{% if listing.snow_plowing %}
								<div class="col-xs-12 col-md-6 col-xl-4">
									<li>Snow Removal</li>
								</div>
							{% endif %}
							{% if listing.garbage_service %}
								<div class="col-xs-12 col-md-6 col-xl-4">
									<li>Garbage Removal</li>
								</div>
							{% endif %}
							{% if listing.security_service %}
								<div class="col-xs-12 col-md-6 col-xl-4">
									<li>Security Service</li>
								</div>							
							{% endif %}
							{% if listing.emergency_maintenance %}
								<div class="col-xs-12 col-md-6 col-xl-4">
									<li>Emergency Maintenance</li>
								</div>							
							{% endif %}				
						</div>
					</div>
				</div>
				<hr style="padding-bottom: 15px;">
			{% endif %}
			{% if listing.hasPets %}
			<div class="row">
				<div class="col-sm-4">
					<h2>Pets Allowed:</h2>
				</div>
				<div class="col-sm-8">
					<div class="row">						
						{% if listing.dogs %}
							<div class="col-xs-12 col-md-6 col-xl-4">
								<li>Dogs</li>
							</div>
						{% endif %}
						{% if listing.cats %}
							<div class="col-xs-12 col-md-6 col-xl-4">
								<li>Cats</li>
							</div>
						{% endif %}
						{% if listing.other_pets %}
							<div class="col-xs-12 col-md-12 col-xl-12">
								{{listing.other_pets}}
							</div>							
						{% endif %}		
					</div>
				</div>
			</div>
			{% endif %}	
		</div>
	</div>

	<!-- Suggest Listing Modal -->
		<div class="modal fade" id="suggestListingModal" tabindex="-1" role="dialog" aria-labelledby="suggestListingModal" aria-hidden="true">
		  	<div class="modal-dialog" role="document">
		    	<div class="modal-content">
		      		<div class="modal-header">
		        		<button type="button" class="close" data-dismiss="modal" aria-label="Close">
		          			<span aria-hidden="true">&times;</span>
		        		</button>
		        		<h4 class="modal-title" id="login"></h4>
		      		</div>
		      		<div class="modal-body">
		      			<div class="row">
		      				<div class="col-xs-1"></div>
		      				<div class="col-xs-10">
		      					{% if current_user.is_authenticated %}
		      					{% for group in groups %}
			      					<div class="card" style="width:100%;">
			      					    <h3 class="card-header">{{ group.name }}</h3>
			      					    <div class="card-block">	        
			      					        <p class="card-text">
			      					        	<strong>Group Leader:</strong>{{ group.leader.fname }} {{ group.leader.lname }}
			      					        </p>
			      					    	<p class="card-text">
			      					    		<strong>Intended Lease Period:</strong> {{ group.start_date }} - {{ group.end_date }}
			      					    	</p>
			      					    	<p class="card-text">
			      					    		<strong><a href=# id="allMembersToggle{{group.id}}">See all members</a></strong>
			      					    		<div id="allMembers{{group.id}}" style="display: none;">
		      					    				{% for user in group.acceptedUsers %}
		      					    			    	<li>{{ user.fname }} {{ user.lname }}</li>
		      					    			    {% endfor %}
			      					    		</div>
			      					    	</p>	      					    	
					      					<button class="btn btn-primary" onClick="favoriteLisitng({{group.id}}, {{listing.id}})" data-dismiss="modal">Favorite Listing</button>
			      					    </div>
			      					</div>
			      					<script>
			      						//Suggest Listing Modal
			      						$('#suggestListingModal').on('show.bs.modal', function (event) {
			      						  var button = $(event.relatedTarget)
			      						  var modal = $(this)
			      						  modal.find('.modal-title').text('Suggest to Which Group?')
			      						})

			      						//Show/hide all members of group
			      						$("#allMembersToggle{{group.id}}").click(function(){
			      						    $("#allMembers{{group.id}}").toggle();
			      						});
			      					</script>
		      					{% endfor %}
		      					{% endif %}
		      				</div>
		      			</div>
		      		</div>
			      	<div class="modal-footer">
			        	<button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
			      	</div>
		    	</div>
		  	</div>
		</div>
		{% include 'listingReportModal.html' %}
		<!-- Tour Request Select Group Modal -->
		<div class="modal fade" id="selectGroupForTourModal" tabindex="-1" role="dialog" aria-labelledby="selectGroupForTourModal" aria-hidden="true">
		  	<div class="modal-dialog" role="document">
		    	<div class="modal-content">
		      		<div class="modal-header">
		      			<strong>Select Which Group You're Requesting this Tour for:</strong>
		        		<button type="button" class="close" data-dismiss="modal" aria-label="Close">
		          			<span aria-hidden="true">&times;</span>
		        		</button>
		        		<h4 class="modal-title" id="login"></h4>
		      		</div>
		      		<div class="modal-body">
		      			<div class="row">
		      				<div class="col-xs-1"></div>
		      				<div class="col-xs-10">
		      					{% if current_user.is_authenticated %}
		      					{% for group in groups %}
			      					<div class="card" style="width:100%;">
			      					    <h3 class="card-header">{{ group.name }}</h3>
			      					    <div class="card-block">	        
			      					        <p class="card-text">
			      					        	<strong>Group Leader:</strong>{{ group.leader.fname }} {{ group.leader.lname }}
			      					        </p>
			      					    	<p class="card-text">
			      					    		<strong>Intended Lease Period:</strong> {{ group.start_date }} - {{ group.end_date }}
			      					    	</p>
			      					    	<p class="card-text">
			      					    		<strong><a href=# id="allTourMembersToggle{{group.id}}">See all members</a></strong>
			      					    		<div id="allTourMembers{{group.id}}" style="display: none;">
		      					    				{% for user in group.acceptedUsers %}
		      					    			    	<li>{{ user.fname }} {{ user.lname }}</li>
		      					    			    {% endfor %}
			      					    		</div>
			      					    	</p>
			      					    	<!-- If group.hasTourForLisiting -->
					      					<button class="btn btn-primary" data-toggle="modal" data-target="#requestTourModal" data-group="{{group.id}}" data-dismiss="modal">Select Group</button>
			      					    </div>
			      					</div>
			      					<script>
			      						//Show/hide all members of group
			      						$("#allTourMembersToggle{{group.id}}").click(function(){
			      						    $("#allTourMembers{{group.id}}").toggle();
			      						});
			      					</script>
		      					{% endfor %}
		      					{% endif %}
		      				</div>
		      			</div>
		      		</div>
			      	<div class="modal-footer">
			        	<button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
			      	</div>
		    	</div>
		  	</div>
		</div>

		<!--Request Tour Modal-->
		<div class="modal fade" id="requestTourModal" tabindex="-1" role="dialog" aria-labelledby="requestTour" aria-hidden="true" style="display: absolute;">
		  	<div class="modal-dialog" role="document">
		    	<div class="modal-content">
		      		<div class="modal-header">		      		
		        		<button type="button" class="close" data-dismiss="modal" aria-label="Close">
		          			<span aria-hidden="true">&times;</span>
		        		</button>
		        		<h4 class="modal-title" id="requestTour"></h4>
		      		</div>
		      		<div class="modal-body">
		      			<div class="row">
		      				<div class="col-xs-1"></div>
		      				<div class="col-xs-10">
		      					<form id="request_tour" action="{{url_for('tours.createTour')}}" method="POST">
		      					    {{ requestTourForm.csrf_token }}
		      					    {{ requestTourForm.group_tour_id }}
		      					    {{ requestTourForm.listing_id(value=listing.id) }}
		      					    {{ requestTourForm.requestedDateTime() }}		
		      					    <input type="text" id="datep" />      					
			      					<div id="datepicker">
			      					  
			      					  
			      					</div>
			      					<br>
			      					<div id="validTimes"></div>
			      					<br>
			      					<div id="doIShowTimeInput" style="display: none;">
			      						<input id="selectedTourTimes" class="selectedTourTimes" type="text" value="" data-role="tagsinput">
			      					</div>

			      					{% from "_formhelpers.html" import render_field %}
			      					<br>
			      					{{ render_field(requestTourForm.description, class="form-control", type="text", required="required") }}
		      					</form>  
		      				</div>
		      			</div>
		      			<div id="groupNumber" style="display: none;"></div>
		      		</div>
			      	<div class="modal-footer">
			        	<button type="button" class="btn btn-primary" onClick="submitTourForm()" data-dismiss="modal">Request Tour</button>
			      	</div>
		    	</div>
		  	</div>
		</div>

		<!-- House Request Select Group Modal -->
		<div class="modal fade" id="selectGroupForHouseModal" tabindex="-1" role="dialog" aria-labelledby="selectGroupForHouseModal" aria-hidden="true">
		  	<div class="modal-dialog" role="document">
		    	<div class="modal-content">
		      		<div class="modal-header">
		      			<strong>Select Which Group You're Requesting this {{listing.property_type}} for:</strong>
		        		<button type="button" class="close" data-dismiss="modal" aria-label="Close">
		          			<span aria-hidden="true">&times;</span>
		        		</button>
		        		<h4 class="modal-title" id="requestHouseGroup"></h4>
		      		</div>
		      		<div class="modal-body">
		      			<div class="row">
		      				<div class="col-xs-1"></div>
		      				<div class="col-xs-10">
		      					{% if current_user.is_authenticated %}
		      					{% for group in groups %}
			      					<div class="card" style="width:100%;">
			      					    <h3 class="card-header">{{ group.name }}</h3>
			      					    <div class="card-block">	        
			      					        <p class="card-text">
			      					        	<strong>Group Leader:</strong>{{ group.leader.fname }} {{ group.leader.lname }}
			      					        </p>
			      					    	<p class="card-text">
			      					    		<strong>Intended Lease Period:</strong> {{ group.start_date }} - {{ group.end_date }}
			      					    	</p>
			      					    	<p class="card-text">
			      					    		<strong><a href=# id="allHouseRequestMembersToggle{{group.id}}">See all members</a></strong>
			      					    		<div id="allHouseRequestMembers{{group.id}}" style="display: none;">
		      					    				{% for user in group.acceptedUsers %}
		      					    			    	<li>{{ user.fname }} {{ user.lname }}</li>
		      					    			    {% endfor %}
			      					    		</div>
			      					    	</p>
			      					    	<!-- If group.hasTourForLisiting -->
					      					<button class="btn btn-primary" data-toggle="modal" data-target="#requestHouseModal" data-group="{{group.id}}" data-dismiss="modal">Select Group</button>
			      					    </div>
			      					</div>
			      					<script>
			      						//Show/hide all members of group
			      						$("#allHouseRequestMembersToggle{{group.id}}").click(function(){
			      						    $("#allHouseRequestMembers{{group.id}}").toggle();
			      						});
			      					</script>
		      					{% endfor %}
		      					{% endif %}
		      				</div>
		      			</div>
		      		</div>
			      	<div class="modal-footer">
			        	<button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
			      	</div>
		    	</div>
		  	</div>
		</div>

		<!--Request House Modal-->
		<div class="modal fade" id="requestHouseModal" tabindex="-1" role="dialog" aria-labelledby="requestHouse" aria-hidden="true">
		  	<div class="modal-dialog" role="document">
		    	<div class="modal-content">
		      		<div class="modal-header">
		        		<button type="button" class="close" data-dismiss="modal" aria-label="Close">
		          			<span aria-hidden="true">&times;</span>
		        		</button>
		        		<h4 class="modal-title" id="requestHouse"></h4>
		      		</div>
		      		<div class="modal-body">
		      			<div class="row">
		      				<div class="col-xs-1"></div>
		      				<div class="col-xs-10">
		      					<form id="request_house" action="{{url_for('housingRequests.create')}}" method="POST">
		      					    {{ requestListingForm.csrf_token }}
		      					    {{ requestListingForm.groupID }}
		      					    {{ requestListingForm.listingID(value=listing.id) }}		      					
			      					{% from "_formhelpers.html" import render_field %}
			      					{{ render_field(requestListingForm.reqDescription, class="form-control", type="text") }}
		      					</form>  
		      				</div>
		      			</div>
		      			<div id="groupNumberHouse" style="display: none;"></div>
		      		</div>
			      	<div class="modal-footer">
			        	<button type="button" class="btn btn-primary" onClick="submitHouseForm()" data-dismiss="modal">Request House</button>
			      	</div>
		    	</div>
		  	</div>
		</div>
	</body>
</html>
{% endblock %}
{% block scripts %}
<script>
	var selectedDateTimes = [];
    var $datePicker = $("div#datepicker");
	requestURL="/landlord/getAvailability/JSON/{{listing.landLordsAsUsers()[0].id}}";
	$.getJSON(requestURL, function(data) {
    	var landlordAvailability = data;
	
    // var landlordAvailability = [{day: 1, time: '8:00AM'}, {day: 2, time: '8:00AM'}, {day: 4, time: '8:00AM'}, {day: 2, time: '10:00AM'}, {day: 4, time: '9:00AM'}, {day: 5, time: '2:00PM'}, {day: 5, time: '3:00PM'}, {day: 5, time: '4:00PM'}, {day: 5, time: '5:00PM'}];
	    var monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"
	    ];
	    var flags = [];
	    var availableDays= [];
	    for(var i=0; i<landlordAvailability.length; i++) {
	        if( flags[landlordAvailability[i].day]) continue;
	        flags[landlordAvailability[i].day] = true;
	        availableDays.push(landlordAvailability[i].day);
	    }
	    console.log(availableDays);

	    $datePicker.datepicker({ 
	        changeMonth: true,
	        changeYear: true,
	        inline: true,
	        altField: "#datep",
	        beforeShowDay:function(date){ 
	                       var day = date.getDay();
	                       if(availableDays.length == 7){
	                       		return [(day == availableDays[0] || day == availableDays[1] || day == availableDays[2] || day == availableDays[3] || day == availableDays[4] || day == availableDays[5] || day == availableDays[6]),""];
	                       }
	                       else if(availableDays.length == 6){
	                       		return [(day == availableDays[0] || day == availableDays[1] || day == availableDays[2] || day == availableDays[3] || day == availableDays[4] || day == availableDays[5]),""];
	                       }
	                       else if(availableDays.length == 5){
	                       		return [(day == availableDays[0] || day == availableDays[1] || day == availableDays[2] || day == availableDays[3] || day == availableDays[4]),""];
	                       }
	                       else if(availableDays.length == 4){
	                       		return [(day == availableDays[0] || day == availableDays[1] || day == availableDays[2] || day == availableDays[3]),""];
	                       }
	                       else if(availableDays.length == 3){
	                       		return [(day == availableDays[0] || day == availableDays[1] || day == availableDays[2]),""];
	                       }
	                       else if(availableDays.length == 2){
	                       		return [(day == availableDays[0] || day == availableDays[1]),""];
	                       }
	                       else if(availableDays.length == 1){
	                       		return [(day == availableDays[0]),""];
	                       }
	                       
	        }   
	     }).change(function(e){
	        setTimeout(function(){
	        	$("#validTimes").empty();
	        	console.log(landlordAvailability);
	        	console.log($datePicker.datepicker('getDate'));
	        	var date = $datePicker.datepicker('getDate');
	        	var month = date.getUTCMonth() +1;
	        	var monthName = monthNames[month-1];
	        	var day = date.getDate();
	        	var year = date.getUTCFullYear();
	        	var dayOfWeek = date.getUTCDay();
	        	var dateForMax = ""+month+"-"+day+"-"+year;
	       		var returnDate = ""+monthName+" "+day+" "+year;
	       		console.log(returnDate);
	        	console.log(dayOfWeek);
	        	var alreadySelectedTimes = returnTimes(selectedDateTimes, returnDate)
	        	console.log(alreadySelectedTimes);
	        	var timesShown =`<div class="row">`;
	        	for (var i = 0; i < landlordAvailability.length; i++ )
	        	{
	        	    if (landlordAvailability[i].day == dayOfWeek)
	        	    {
	        	    	timesShown+= `<div class="col-xs-4">
	    						 <div class="form-group">
	    						 		<label class="control-label form-control-feedback" id="timelabel"style="font-size: 1.5em">`+ landlordAvailability[i].time+`</label>
										<div class="checkbox">
											<label style="font-size: 1.5em">
								    		<input class="form-check-input tourtime" type="checkbox" onClick="addTime('`+returnDate+`','`+dateForMax+`','`+landlordAvailability[i].time+`')" id="date_`+returnDate+"_time_"+landlordAvailability[i].time+`" value="`+landlordAvailability[i].time+`"`;
								    		for(var k=0; k<alreadySelectedTimes.length; k++){
								    			if(alreadySelectedTimes[k]==landlordAvailability[i].time){
								    				timesShown+= `checked`;
								    			}
								    		}
								    		timesShown+= `>
								    		<span class="cr"><i class="cr-icon fa fa-check-circle"></i></span>
								  			</label>
										</div>
									</div>
							 </div>`;
					}
				}
	        	timesShown+= `</div>`;
		        $("#validTimes").append(timesShown);
	        });
	    });
	    $(".ui-datepicker").css("margin","auto");
	});

	function addTime(date, dateForMax, time){
		$("#doIShowTimeInput").show();
		if(checkDateTime(selectedDateTimes, dateForMax, time) == false){
			var nextDateTime = ""+dateForMax + " " + time;
			selectedDateTimes.push(nextDateTime);
			$('#selectedTourTimes').tagsinput('add', ""+ date + " @ " +time);
		}
		else{
			$('#selectedTourTimes').tagsinput('remove', ""+ date + " @ " +time);
			console.log('already exists');
		}
		console.log(selectedDateTimes);
		$("#requestedDateTime").val(JSON.stringify(selectedDateTimes));
		console.log($("#requestedDateTime").val());
	}


	function checkKeyPair(obj, key, value){
		return obj.hasOwnProperty(key);
	}

	function checkDateTime(obj, date, time)
	{
		//debugger;
		console.log(obj);
	    for (i = 0; i < obj.length; i++ )
	    {
	        if (obj[i] == ""+date+ " " + time)
	        {	        	
        		selectedDateTimes.splice(i,1);
            	return true;	        	
	        }
	    }
	    return false;
	}

	function returnTimes(obj, date)
	{
		var times= [];
	    for (i = 0; i < obj.length; i++ )
	    {
	        if (obj[i].date == date)
	        {
	        	times.push(obj[i].time);
	        }
	    }
	    return times;
	}

	$( document ).ready(function() {
	    $(".ui-datepicker").css("margin","auto");
	    $('.selectedTourTimes').attr('readonly', 'readonly');
	});

	$('input').on('itemRemoved', function(event) {
	  console.log(event);
	  var removedItem = event.item;
	  var fields = removedItem.split('@');
	  var date = fields[0];
	  date = date.trim();
	  var time = fields[1];
	  time = time.trim();
	  console.log(date);
	  console.log(time);
	  checkDateTime(selectedDateTimes, date, time);
	  console.log(selectedDateTimes);
	  $("#date_"+date+"_time_"+time).prop('checked', false);
	  console.log("#date_"+date+"_time_"+time);
	  var elementExists = document.getElementById("date_"+date+"_time_"+time);
	  console.log(elementExists);
	});

    //Request Tour Modal
    $('#requestTourModal').on('show.bs.modal', function (event) {
      var button = $(event.relatedTarget);
      var modal = $(this);
      var group = $(event.relatedTarget).data('group');
      modal.find('.modal-title').text('Request To Tour This Property');
      modal.find('#groupNumber').text(group);
      modal.css('position', 'absolute');
    })

    //Request House Modal
    $('#requestHouseModal').on('show.bs.modal', function (event) {
      var button = $(event.relatedTarget);
      var modal = $(this);
      var group = $(event.relatedTarget).data('group');
      modal.find('.modal-title').text('Request to live at this {{listing.property_type}}');
      modal.find('#groupNumberHouse').text(group);
    })

    //Listing Report
    $('#listingReportModal').on('show.bs.modal', function (event) {
      var button = $(event.relatedTarget)
      var modal = $(this)
      modal.find('.modal-title').text('Report This Listing');
      var url = window.location.href;
      $("#sourceURL").val(url);
      $("#listing_id").val({{listing.id}})
    });

    function submitTourForm() {
    	$("#group_tour_id").val($("#groupNumber").text());
    	// $("#requestedDateTime").val($("#tourRequestTime").val());
        $("#request_tour").submit();
    }

    function submitHouseForm() {
    	$("#groupID").val($("#groupNumberHouse").text());
        $("#request_house").submit();
    }

    function favoriteLisitng(groupID, listingID){
		$.ajax({
		    type: "GET",
		    url: "/group/"+groupID+"/favoriteListing/"+listingID,
		    success: function(data){	    	    	
		    	if(data.results.success == false){
		    	    $("#favorited"+listingID).empty();
		    	    $("#favorited"+listingID).append(
		    	    `<div class="alert alert-info alert-dismissible show" role="alert">
		    	        <button type="button" class="close" data-dismiss="alert" aria-label="Close">
		    	            <span aria-hidden="true">&times;</span>
		    	          </button>
		    	        <strong>This listing has already been suggested to this group</strong>
		    	    </div>`);
		    	}
		    	else{
		    	    $("#favorited"+listingID).empty();
		    	    $("#favorited"+listingID).append(
		    	    `<div class="alert alert-success alert-dismissible show" role="alert">
		    	        <button type="button" class="close" data-dismiss="alert" aria-label="Close">
		    	            <span aria-hidden="true">&times;</span>
		    	          </button>
		    	        <strong>Succesfully Suggested To Your Group!</strong>
		    	    </div>`);
		    	}
		    },
		    failure: function(errMsg) {
		        alert(errMsg);
		    }
		});
    }

    var groups = {};
    $('.galleryItem').each(function() {
      var id = parseInt($(this).attr('data-group'), 10);
      
      if(!groups[id]) {
        groups[id] = [];
      } 
      
      groups[id].push( this );
    });


    $.each(groups, function() {
      
      $(this).magnificPopup({
          type: 'image',
          closeOnContentClick: true,
          closeBtnInside: false,
          gallery: { enabled:true }
      })
      
    });

    $('.test-popup-link').magnificPopup({
      type: 'image'
      // other options
    });

    jQuery(function($) {
      'use strict';

      // -------------------------------------------------------------
      //   Basic Navigation
      // -------------------------------------------------------------
      (function() {
        var $frame = $('#basic');
        var $slidee = $frame.children('ul').eq(0);
        var $wrap = $frame.parent();

        // Call Sly on frame
        $frame.sly({
          horizontal: 1,
          itemNav: 'basic',
          smart: 1,
          activateOn: 'click',
          mouseDragging: 1,
          touchDragging: 1,
          releaseSwing: 1,
          startAt: 3,
          scrollBar: $wrap.find('.scrollbar'),
          scrollBy: 1,
          pagesBar: $wrap.find('.pages'),
          activatePageOn: 'click',
          speed: 300,
          elasticBounds: 1,
          easing: 'easeOutExpo',
          dragHandle: 1,
          dynamicHandle: 1,
          clickBar: 1,

          // Buttons
          forward: $wrap.find('.forward'),
          backward: $wrap.find('.backward'),
          prev: $wrap.find('.prev'),
          next: $wrap.find('.next'),
          prevPage: $wrap.find('.prevPage'),
          nextPage: $wrap.find('.nextPage')
        });

        // To Start button
        $wrap.find('.toStart').on('click', function() {
          var item = $(this).data('item');
          // Animate a particular item to the start of the frame.
          // If no item is provided, the whole content will be animated.
          $frame.sly('toStart', item);
        });

        // To Center button
        $wrap.find('.toCenter').on('click', function() {
          var item = $(this).data('item');
          // Animate a particular item to the center of the frame.
          // If no item is provided, the whole content will be animated.
          $frame.sly('toCenter', item);
        });

        // To End button
        $wrap.find('.toEnd').on('click', function() {
          var item = $(this).data('item');
          // Animate a particular item to the end of the frame.
          // If no item is provided, the whole content will be animated.
          $frame.sly('toEnd', item);
        });

        // Add item
        $wrap.find('.add').on('click', function() {
          $frame.sly('add', '<li>' + $slidee.children().length + '</li>');
        });

        // Remove item
        $wrap.find('.remove').on('click', function() {
          $frame.sly('remove', -1);
        });
      }());

      // -------------------------------------------------------------
      //   Centered Navigation
      // -------------------------------------------------------------
      (function() {
        var $frame = $('#centered');
        var $wrap = $frame.parent();

        // Call Sly on frame
        $frame.sly({
          horizontal: 1,
          itemNav: 'centered',
          smart: 1,
          activateOn: 'click',
          mouseDragging: 1,
          touchDragging: 1,
          releaseSwing: 1,
          startAt: 4,
          scrollBar: $wrap.find('.scrollbar'),
          scrollBy: 1,
          speed: 300,
          elasticBounds: 1,
          easing: 'easeOutExpo',
          dragHandle: 1,
          dynamicHandle: 1,
          clickBar: 1,

          // Buttons
          prev: $wrap.find('.prev'),
          next: $wrap.find('.next')
        });
      }());

      // -------------------------------------------------------------
      //   Force Centered Navigation
      // -------------------------------------------------------------
      (function() {
        var $frame = $('#forcecentered');
        var $wrap = $frame.parent();

        // Call Sly on frame
        $frame.sly({
          horizontal: 1,
          itemNav: 'forceCentered',
          smart: 1,
          activateMiddle: 1,
          activateOn: 'click',
          mouseDragging: 1,
          touchDragging: 1,
          releaseSwing: 1,
          startAt: 0,
          scrollBar: $wrap.find('.scrollbar'),
          scrollBy: 1,
          speed: 300,
          elasticBounds: 1,
          easing: 'easeOutExpo',
          dragHandle: 1,
          dynamicHandle: 1,
          clickBar: 1,

          // Buttons
          prev: $wrap.find('.prev'),
          next: $wrap.find('.next')
        });
      }());

      // -------------------------------------------------------------
      //   Cycle By Items
      // -------------------------------------------------------------
      (function() {
        var $frame = $('#cycleitems');
        var $wrap = $frame.parent();

        // Call Sly on frame
        $frame.sly({
          horizontal: 1,
          itemNav: 'basic',
          smart: 1,
          activateOn: 'click',
          mouseDragging: 1,
          touchDragging: 1,
          releaseSwing: 1,
          startAt: 0,
          scrollBar: $wrap.find('.scrollbar'),
          scrollBy: 1,
          speed: 300,
          elasticBounds: 1,
          easing: 'easeOutExpo',
          dragHandle: 1,
          dynamicHandle: 1,
          clickBar: 1,

          // Cycling
          cycleBy: 'items',
          cycleInterval: 1000,
          pauseOnHover: 1,

          // Buttons
          prev: $wrap.find('.prev'),
          next: $wrap.find('.next')
        });

        // Pause button
        $wrap.find('.pause').on('click', function() {
          $frame.sly('pause');
        });

        // Resume button
        $wrap.find('.resume').on('click', function() {
          $frame.sly('resume');
        });

        // Toggle button
        $wrap.find('.toggle').on('click', function() {
          $frame.sly('toggle');
        });
      }());

      // -------------------------------------------------------------
      //   Cycle By Pages
      // -------------------------------------------------------------
      (function() {
        var $frame = $('#cyclepages');
        var $wrap = $frame.parent();

        // Call Sly on frame
        $frame.sly({
          horizontal: 1,
          itemNav: 'basic',
          smart: 1,
          activateOn: 'click',
          mouseDragging: 1,
          touchDragging: 1,
          releaseSwing: 1,
          startAt: 0,
          scrollBar: $wrap.find('.scrollbar'),
          scrollBy: 1,
          pagesBar: $wrap.find('.pages'),
          activatePageOn: 'click',
          speed: 300,
          elasticBounds: 1,
          easing: 'easeOutExpo',
          dragHandle: 1,
          dynamicHandle: 1,
          clickBar: 1,

          // Cycling
          cycleBy: 'pages',
          cycleInterval: 1000,
          pauseOnHover: 1,
          startPaused: 1,

          // Buttons
          prevPage: $wrap.find('.prevPage'),
          nextPage: $wrap.find('.nextPage')
        });

        // Pause button
        $wrap.find('.pause').on('click', function() {
          $frame.sly('pause');
        });

        // Resume button
        $wrap.find('.resume').on('click', function() {
          $frame.sly('resume');
        });

        // Toggle button
        $wrap.find('.toggle').on('click', function() {
          $frame.sly('toggle');
        });
      }());

      // -------------------------------------------------------------
      //   One Item Per Frame
      // -------------------------------------------------------------
      (function() {
        var $frame = $('#oneperframe');
        var $wrap = $frame.parent();

        // Call Sly on frame
        $frame.sly({
          horizontal: 1,
          itemNav: 'forceCentered',
          smart: 1,
          activateMiddle: 1,
          mouseDragging: 1,
          touchDragging: 1,
          releaseSwing: 1,
          startAt: 0,
          scrollBar: $wrap.find('.scrollbar'),
          scrollBy: 1,
          speed: 300,
          elasticBounds: 1,
          easing: 'easeOutExpo',
          dragHandle: 1,
          dynamicHandle: 1,
          clickBar: 1,

          // Buttons
          prev: $wrap.find('.prev'),
          next: $wrap.find('.next')
        });
      }());

      // -------------------------------------------------------------
      //   Crazy
      // -------------------------------------------------------------
      (function() {
        var $frame = $('#crazy');
        var $slidee = $frame.children('ul').eq(0);
        var $wrap = $frame.parent();

        // Call Sly on frame
        $frame.sly({
          horizontal: 1,
          itemNav: 'basic',
          smart: 1,
          activateOn: 'click',
          mouseDragging: 1,
          touchDragging: 1,
          releaseSwing: 1,
          startAt: 3,
          scrollBar: $wrap.find('.scrollbar'),
          scrollBy: 1,
          pagesBar: $wrap.find('.pages'),
          activatePageOn: 'click',
          speed: 300,
          elasticBounds: 1,
          easing: 'easeOutExpo',
          dragHandle: 1,
          dynamicHandle: 1,
          clickBar: 1,

          // Buttons
          forward: $wrap.find('.forward'),
          backward: $wrap.find('.backward'),
          prev: $wrap.find('.prev'),
          next: $wrap.find('.next'),
          prevPage: $wrap.find('.prevPage'),
          nextPage: $wrap.find('.nextPage')
        });

        // To Start button
        $wrap.find('.toStart').on('click', function() {
          var item = $(this).data('item');
          // Animate a particular item to the start of the frame.
          // If no item is provided, the whole content will be animated.
          $frame.sly('toStart', item);
        });

        // To Center button
        $wrap.find('.toCenter').on('click', function() {
          var item = $(this).data('item');
          // Animate a particular item to the center of the frame.
          // If no item is provided, the whole content will be animated.
          $frame.sly('toCenter', item);
        });

        // To End button
        $wrap.find('.toEnd').on('click', function() {
          var item = $(this).data('item');
          // Animate a particular item to the end of the frame.
          // If no item is provided, the whole content will be animated.
          $frame.sly('toEnd', item);
        });

        // Add item
        $wrap.find('.add').on('click', function() {
          $frame.sly('add', '<li>' + $slidee.children().length + '</li>');
        });

        // Remove item
        $wrap.find('.remove').on('click', function() {
          $frame.sly('remove', -1);
        });
      }());
    });
</script>
{% endblock %}
