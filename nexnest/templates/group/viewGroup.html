{% extends "base.html" %}
{% block content %}
    <br>
    <div class="row m-x-auto">
        <div class="col-xs-1 col-sm-2 col-md-2 col-lg-2 col-xl-4">
            Messages
            {% for message in messages %}
                Message {{message.id}}<br>
                Content {{message.content}}<br>
                Date {{message.date_created}}<br>
                <hr>
            {% endfor %}
            {% from "_formhelpers.html" import render_field %}
            <form action="{{url_for('groups.createMessage')}}" method=post>
            {{invite_form.csrf_token}}
                <dl>
                    {{ render_field(message_form.content, class="form-control", type="text") }}
                    {{message_form.group_id}}
                </dl>
                <p>
                    <input type='submit' value='Send Message' class="btn btn-info">
                </p>
            </form>
        </div>
        <div class="col-xs-10 col-sm-8 col-md-8 col-lg-8 col-xl-4">
            <div class="row">
                <div class="card" style="width:100%;">
                    <h3 class="card-header">{{ group.name }}</h3>
                    <div class="card-block">            
                        <p class="card-text">
                            <strong>Group Leader:</strong> <a href="{{ url_for('users.viewUser', userID=group.leader.id) }}">{{ group.leader.fname }} {{ group.leader.lname }}</a>
                        </p>
                        <p class="card-text">
                            Intended Lease Period: {{ group.start_date }} - {{ group.end_date }}
                        </p>
                        <strong>Current Group Members:</strong>
                        {% for user in group.acceptedUsers %}
                            <li><a href="{{ url_for('users.viewUser', userID=user.id) }}">{{ user.fname }} {{ user.lname }}</a></li>
                        {% endfor %}                        
                        {% if group. unAcceptedUsers %}
                            <br>
                            <strong>Invited Members:</strong>
                            {% for user in group.unAcceptedUsers %}
                                <li><a href="{{ url_for('users.viewUser', userID=user.id) }}">{{ user.fname }} {{ user.lname }}</a></li>
                            {% endfor %}
                        {% endif %}
                        <br>
                        <strong>Invite User to Group:</strong>
                        <div class="row">
                            <div class="col-xs-12 col-sm-10 col-md-8 col-lg-8 col-xl-6">                        
                                <input id="userSearch" type="text" class="form-control" aria-describedby="searchHelpBlock" style="width:100%;">
                            </div>
                        </div>
                        <p id="searchHelpBlock" class="form-text text-muted">
                            Search by Username (first part of email)
                        </p>                        
                        <form id="invite_user" action="{{url_for('groups.invite')}}" method="POST">
                            {{invite_form.csrf_token}}
                            {{invite_form.group_id(value=group.id)}}
                            {{invite_form.user_id}}
                        </form>
                        <span class="" id="userSearchUL"></span>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock %}
{% block scripts %}
<script>
    function submitForm(id) {
        $("#user_id").val(id);
        $("#invite_user").submit()
    }
    
    $("#userSearch").keyup(function() {
        var keyToSearch = $("#userSearch").val();
        // alert($("#userSearch").val())
        $("#userSearchUL").empty();
        $.getJSON("/user/search/" + keyToSearch + "/" + {{group.id}}, function(data) {
            //clear div to prevent case of users typing to fast resulting in duplicate results
            $("#userSearchUL").html('<strong>Results:</strong');
            $.each(data.users, function(key, user) {
                userString = '<hr>'+
                            '<div id="' + user.id + '" class="row">'+
                                '<div class=col-xs-10>' +
                                    '<a href="/viewUser/' + user.id + '">' + 
                                        user.username + ' (' + user.fname + ' ' + user.lname + ')' +
                                    '</a>' +
                                '</div>'+
                                '<div class="col-xs-1">' +
                                    '<span onClick="submitForm(this.id)" class="invite btn btn-primary" id="' + user.id + '">Invite</span>'+
                                '</div>' +
                            '</div><br>';

                $("#userSearchUL").append(userString);
            });
            
        });
    });
</script>
{% endblock %}
