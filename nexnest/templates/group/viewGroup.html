{% extends "base.html" %}
{% block content %}
    <br>
    <div class="row m-x-auto">
        <div class="col-xs-1">
        </div>
        <div class="col-xs-10">
            <div class="callout-block text-center fade-in-b">
                <h1>
                    <b>{{ group.name }}</b>
                </h1>
                <p><small>Intended Lease Period: {{ group.start_date }} - {{ group.end_date }}</small></p>
            </div>
        </div>
    </div>
    <br>
    <div class="row m-x-auto">
        <div class="col-xs-1">
        </div>
        <div class="col-md-6 col-lg-6 col-xl-6">
            <div class="row">
                <div class="card" style="width:100%;">
                    <h3 class="card-header">Type your message:</h3>
                    <div class="card-block">
                        <!-- Add new message -->
                        <div class="form-group">
                            <form action="{{url_for('groups.createMessage')}}" method='POST'>
                                {{message_form.group_id}}
                                {{message_form.csrf_token}}
                                <div class="row">
                                    {{message_form.content(class="form-control", rows=5)}}
                                </div>
                                <div class="row" style="padding-top: 10px; text-align:-webkit-right;">
                                    <div class="col-xs-12">
                                        <input class="btn btn-primary" type="submit" value="Respond">
                                    </div>                                    
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
                    <!-- Messages -->
                    {% for message in messages %}
                        <div class="card" style="width: 100%;">
                            <div class="card-block">
                                <div class="row">
                                    <div class="col-xs-2 col-xl-1" style="height: 50px;">
                                        <img src="{{message.user.profile_image}}" alt="Profile Image" class="img-responsive" style="height: 100%" />
                                    </div>
                                    <div class="col-xs-10">
                                        <div class="row">
                                            <h4 class="card-title">
                                                {{ message.user.fname }} {{ message.user.lname }}
                                                {% if group.leader_id == message.user.id %}
                                                    <h6 style="padding-top: 10px;"><span class="tag tag-primary">Group Leader</span></h6>
                                                {% endif %}
                                            </h4>
                                        </div>
                                        <div class="row">
                                            <h6 class="card-subtitle mb-2 text-muted">{{ message.date_created }}</h6>
                                        </div>
                                    </div>
                                </div>                                   
                                <div class="row">
                                    <div class="col-xs-12">
                                        <p class="card-text">{{ message.content }}</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    {% endfor %}
            </div>
        </div>
        <!--Info Pane-->
        <div class="col-md-4 col-lg-4 col-xl-4" style="padding-left: 5%;">
            <div class="row">
                <div class="card" style="width:100%;">
                    <div class="card-block">
                        <ul class="nav nav-tabs">
                            <li class="nav-item">
                                <a class="nav-link active" data-toggle="tab" href="#memberInfo" role="tab">Members</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" data-toggle="tab" href="#suggestedListings" role="tab">Suggested Listings</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" data-toggle="tab" href="#tours" role="tab">Tours</a>
                            </li>
                        </ul>
                        <br>
                        <div class="tab-content">
                            <div class="tab-pane active" id="memberInfo" role="tabpanel">
                                <strong>Current Group Members:</strong>
                                {% for user in group.acceptedUsers %}                                    
                                    {% include 'group/member.html' %}
                                {% endfor %}                        
                                {% if group.unAcceptedUsers %}
                                {% if group.leader_id == current_user.id %}
                                    <a href='#' class="btn btn-primary" data-toggle="modal" data-target="#changeGroupLeaderModal">Change Group Leader</a>
                                    <br><br>
                                {% endif %}
                                <strong>Invited Members:</strong>
                                {% for user in group.unAcceptedUsers %}
                                    {% include 'group/member.html' %}
                                {% endfor %}
                                {% endif %}

                                <!-- Group Leader Actions -->
                                {% if group.leader_id == current_user.id %}
                                <br>
                                <strong>Invite User to Group:</strong>
                                <div class="row">
                                    <div class="col-xs-12 col-sm-10 col-md-8 col-lg-8 col-xl-6">                        
                                        <input id="userSearch" type="text" class="form-control" aria-describedby="searchHelpBlock" style="width:100%;">
                                    </div>
                                </div>
                                <p id="searchHelpBlock" class="form-text text-muted">
                                    Search by Username (first part of email)
                                </p>                        
                                <form id="invite_user" action="{{url_for('groups.invite')}}" method="POST">
                                    {{invite_form.csrf_token}}
                                    {{invite_form.group_id(value=group.id)}}
                                    {{invite_form.user_id}}
                                </form>
                                <span class="" id="userSearchUL"></span>
                                {% endif %}
                            </div>
                            <div class="tab-pane" id="suggestedListings" role="tabpanel">
                                {% for listing in suggestedListings %}
                                    <div class="row m-x-auto">
                                        <div class="col-md-12" style="padding-left: 30px; padding-right: 30px;">
                                            <a href="{{ url_for('listings.viewListing', listingID=listing.id) }}">
                                                <img src="{{url_for('static', filename='img/testHouse.jpg')}}" class="listingImg">
                                                <div class="listingDescription d-flex align-items-end">
                                                    {{ listing.num_bedrooms }}<i class="fa fa-bed" aria-hidden="true"></i> ${{ listing.price }}
                                                    <br>
                                                    {{ listing.street }}, {{ listing.city }}, {{ listing.state }}
                                                </div>
                                            </a>
                                        </div>     
                                    </div>
                                    <hr>
                                {% endfor %}
                            </div>
                            <div class="tab-pane" id="tours" role="tabpanel">
                                Tours
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Leave Group Modal -->
    <div class="modal fade" id="leaveGroupModal{{group.id}}" tabindex="-1" role="dialog" aria-labelledby="leaveGroup" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                    <h4 class="modal-title" id="leaveGroup"></h4>
                </div>
                {% if group.leader_id == current_user.id %}
                <div class="modal-body">
                    You are the group leader, you can't leave without choosing a new group leader
                </div>
                {% endif %}
                <div class="modal-footer">
                    <div class="btn-group">
                    {% if group.leader_id == current_user.id %}
                        <a href='#' class="btn btn-primary" data-toggle="modal" data-target="#changeGroupLeaderModal" data-dismiss="modal">Change Group Leader</a>
                    {% else %}
                        <button class="btn btn-danger" onClick="leaveGroup({{group.id}})">Leave Group</button>
                    {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Change Group Leader Modal -->
    <div class="modal fade" id="changeGroupLeaderModal" tabindex="-1" role="dialog" aria-labelledby="changeLeader" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                    <h4 class="modal-title" id="changeLeader"></h4>
                </div>
                <div class="modal-body">
                    <h4>Which user would you like to promote to group leader?</h4>
                    {% for user in group.acceptedUsers %}                                    
                        {% include 'group/promoteMember.html' %}
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>

    <!-- Remove User From Group Modal -->
    <div class="modal fade" id="removeUser" tabindex="-1" role="dialog" aria-labelledby="removeUser" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                    <h4 class="modal-title" id="removeUser"></h4>
                </div>
                <div class="modal-body">
                    <h4>Are you sure you wish to remove</h4>
                </div>
                <div class="modal-footer">
                    <div class="btn-group">
                        <button class="btn btn-danger" onClick="">Remove</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock %}
{% block scripts %}
<script>
    function setID(id){
        $("#group_id").val(id);
    }
    function submitForm(id) {
        $("#user_id").val(id);
        $("#invite_user").submit()
    }

    function leaveGroup(id) {
        window.location.href="/group/leave/" + id;
    }
    
    $("#userSearch").keyup(function() {
        var keyToSearch = $("#userSearch").val();
        // alert($("#userSearch").val())
        $("#userSearchUL").empty();
        $.getJSON("/user/search/" + keyToSearch + "/" + {{group.id}}, function(data) {
            //clear div to prevent case of users typing to fast resulting in duplicate results
            $("#userSearchUL").html('<strong>Results:</strong');
            $.each(data.users, function(key, user) {
                userString = '<hr>'+
                            '<div id="' + user.id + '" class="row">'+
                                '<div class=col-xs-10>' +
                                    '<a href="/user/view/' + user.id + '">' + 
                                        user.username + ' (' + user.fname + ' ' + user.lname + ')' +
                                    '</a>' +
                                '</div>'+
                                '<div class="col-xs-1">' +
                                    '<span onClick="submitForm(this.id)" class="invite btn btn-primary" id="' + user.id + '">Invite</span>'+
                                '</div>' +
                            '</div><br>';

                $("#userSearchUL").append(userString);
            });
            
        });
    });

    //Show/hide each div
    $("#allMembersToggle{{group.id}}").click(function(){
        $("#allMembers{{group.id}}").toggle();
    });

    //Leave Group jquery
    $('#leaveGroupModal{{group.id}}').on('show.bs.modal', function (event) {
        var button = $(event.relatedTarget)
        var modal = $(this)
        modal.find('.modal-title').text('Leave {{ group.name }}?')
    })

    //Change Leader jquery
    $('#changeGroupLeaderModal').on('show.bs.modal', function (event) {
        var button = $(event.relatedTarget)
        var modal = $(this)
        modal.find('.modal-title').text('Change Group Leader')
    })

    //Remove User jquery
    $('#removeUser').on('show.bs.modal', function (event) {
        var button = $(event.relatedTarget)
        var modal = $(this)
        modal.find('.modal-title').text('Remove From Group')
    })
</script>
{% endblock %}
